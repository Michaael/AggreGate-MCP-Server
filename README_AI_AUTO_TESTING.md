# Автоматическое тестирование и валидация для ИИ

## Проблема

При выполнении заданий через MCP ИИ создает элементы, но не проверяет их работоспособность, что приводит к неработающим заданиям.

## Решение

Созданы три документа с правилами и инструментами для автоматического тестирования:

### 1. `AI_AUTO_TESTING_GUIDE.md`
Полное руководство по автоматическому тестированию:
- Чек-листы проверки после создания элементов
- Автоматическое исправление ошибок
- Валидация функций, моделей, привязок
- Примеры кода для автоматического исправления

### 2. `AI_WORKFLOW_RULES.md`
Практические правила рабочего процесса для ИИ:
- Правило 1: Создание функции = Создание + Тестирование + Исправление
- Правило 2: Создание модели = Создание + Проверка + Привязки
- Правило 3: Автоматическое исправление ошибок
- Чек-листы для каждого задания
- Примеры правильного выполнения

### 3. `auto_validate_task.py`
Python скрипт с функциями валидации:
- `validate_function()` - валидация функции с автоматическим тестированием
- `validate_model()` - валидация модели
- `validate_bindings()` - валидация привязок
- `validate_task_complete()` - полная валидация задания

## Как использовать

### Для ИИ (в инструкциях):

1. **При создании функции:**
   ```
   - aggregate_build_expression() - для правильных форматов
   - aggregate_validate_expression() - для проверки
   - aggregate_create_function() - создание
   - aggregate_test_function() - ОБЯЗАТЕЛЬНО тестировать
   - Если ошибка - исправить и повторить тест
   ```

2. **При создании модели:**
   ```
   - Создать модель
   - Создать переменные, события, функции
   - Проверить через list_*
   - Протестировать функции
   - Создать привязки (если нужны)
   ```

3. **После каждого задания:**
   ```
   - Проверить все элементы
   - Протестировать все функции
   - Проверить привязки
   - Задокументировать ограничения
   ```

### Для пользователя:

1. **Перед началом работы с ИИ:**
   - Убедитесь, что ИИ знает о существовании этих правил
   - Попросите ИИ следовать правилам из `AI_WORKFLOW_RULES.md`

2. **При проверке работы ИИ:**
   - Проверьте, что ИИ тестирует функции после создания
   - Проверьте, что ИИ создает привязки для моделей
   - Проверьте, что ИИ исправляет ошибки автоматически

3. **Если задания не работают:**
   - Проверьте отчет `TASKS_VERIFICATION_REPORT.md`
   - Используйте `auto_validate_task.py` для диагностики
   - Следуйте инструкциям из `AI_AUTO_TESTING_GUIDE.md`

## Ключевые правила

### Типы моделей (КРИТИЧНО!)

В AggreGate есть три типа моделей:
1. **Относительная** (type=0) - много экземпляров, относительные ссылки `{.:var}` в привязках
2. **Абсолютная** (type=1) - один экземпляр, абсолютные пути в привязках
3. **Экземплярная** (type=2) - создается по требованию

**Для относительной модели ОБЯЗАТЕЛЬНО:**
- Установить `containerType="devices"` и `objectType="device"`
- Использовать относительные ссылки в привязках: `{.:sine}`, а не `{users.admin.devices.device1:sine}`

Подробнее: [docs/MCP_MODEL_TYPES_GUIDE.md](docs/MCP_MODEL_TYPES_GUIDE.md)

## Ключевые правила

### ✅ ВСЕГДА делать:
1. Тестировать функции после создания (`aggregate_test_function` или `aggregate_call_function` для множественных полей)
2. Проверять создание элементов (`aggregate_list_*`)
3. **КРИТИЧНО:** Проверять inputFormat через `aggregate_get_function` - все поля должны присутствовать
4. Для функций с множественными полями использовать формат С `<<>>` скобками
5. Создавать привязки для моделей, работающих с устройствами
6. Использовать `aggregate_build_expression` перед созданием Expression функций
7. Исправлять ошибки автоматически

### ❌ НИКОГДА не делать:
1. Создавать функцию без тестирования
2. Создавать модель без проверки элементов
3. Забывать про привязки
4. Игнорировать ошибки тестирования
5. Пропускать валидацию форматов
6. **КРИТИЧНО:** Использовать формат без `<<>>` для функций с множественными полями
7. Пропускать проверку inputFormat через `aggregate_get_function` после создания

## Примеры использования

### Пример 1: Создание функции с автоматическим тестированием

```python
# ИИ должен делать так:
1. built = aggregate_build_expression(...)
2. validation = aggregate_validate_expression(...)
3. aggregate_create_function(...)
4. test = aggregate_test_function(...)
5. if not test.success:
     - исправить ошибки
     - повторить тест
```

### Пример 2: Создание модели с привязками

```python
# ИИ должен делать так:
1. aggregate_create_context(...)
2. aggregate_create_variable(...)
3. aggregate_list_variables(...) - проверить
4. aggregate_set_variable(..., "bindings", ...) - создать привязки
5. aggregate_get_variable(..., "bindings") - проверить привязки
```

## Результат

После внедрения этих правил:
- ✅ Все функции будут протестированы после создания
- ✅ Все ошибки будут исправлены автоматически
- ✅ Все привязки будут созданы
- ✅ Все задания будут работать или иметь четкие инструкции по доработке

## Дополнительные ресурсы

- `TASKS_VERIFICATION_REPORT.md` - отчет о проверке всех заданий
- `docs/MCP_AI_QUICK_REFERENCE.md` - быстрая справка по MCP
- `docs/MCP_AI_MODEL_GUIDE.md` - полное руководство по моделям
