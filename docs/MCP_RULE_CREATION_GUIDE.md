# Руководство по созданию правил в AggreGate через MCP

## ⚠️ Важные правила для предотвращения ошибок

### 1. Правила создаются через действия (Actions)

**Критически важно:** Правила в AggreGate создаются через действия, а не напрямую через API. Это отличается от переменных и событий.

### 2. Формат данных заполняется динамически

**Проблема:** Действия для создания правил могут иметь разные форматы входных данных в зависимости от версии AggreGate и типа контекста.

**Решение:** Инструмент `aggregate_create_rule` использует следующий подход:

1. **Проверка существования действия** - перед попыткой использования действия проверяется его наличие
2. **Пустой входной DataTable** - действие инициализируется с пустым входом
3. **Динамическое заполнение через EditData** - данные заполняются через команды EditData, которые приходят от действия
4. **Безопасная установка полей** - проверяется наличие поля перед установкой значения

### 3. Поддерживаемые имена действий

Инструмент пытается следующие имена действий (в порядке приоритета):
- `addRule`
- `createRule`
- `setRule`
- `add`
- `create`

### 4. Поддерживаемые имена полей

Инструмент пытается различные варианты имен полей для максимальной совместимости:

**Имя правила:**
- `name`, `ruleName`, `rule_name`, `Name`, `RuleName`

**Триггер:**
- `trigger`, `Trigger`, `ruleTrigger`

**Выражение:**
- `expression`, `Expression`, `ruleExpression`, `code`

**Включено:**
- `enabled`, `Enabled`, `isEnabled`, `active`

**Описание:**
- `description`, `Description`, `desc`

**Группа:**
- `group`, `Group`, `category`

### 5. Обработка ошибок

Инструмент включает улучшенную обработку ошибок:

1. **Проверка доступных действий** - если все действия не найдены, выводится список доступных действий
2. **Безопасная установка полей** - если поле не найдено, ошибка игнорируется (некоторые поля могут быть опциональными)
3. **Подробные сообщения об ошибках** - включают информацию о попытках и доступных действиях

## Примеры использования

### Создание простого правила

```json
{
  "tool": "aggregate_create_rule",
  "parameters": {
    "path": "users.admin.models.myModel",
    "ruleName": "updateCounter",
    "trigger": "temperature",
    "expression": "counter = counter + 1;",
    "enabled": true,
    "description": "Увеличивать счетчик при изменении температуры"
  }
}
```

### Создание правила с условием

```json
{
  "tool": "aggregate_create_rule",
  "parameters": {
    "path": "users.admin.models.myModel",
    "ruleName": "checkTemperature",
    "trigger": "temperature",
    "expression": "if (temperature > 30) { status = 'high'; }",
    "enabled": true,
    "description": "Проверка температуры",
    "group": "Monitoring"
  }
}
```

## Типичные ошибки и решения

### Ошибка: "Поле 'name' не найдено в записи"

**Причина:** Действие ожидает другой формат данных или другие имена полей.

**Решение:** Инструмент автоматически пытается различные варианты имен полей. Если ошибка все еще возникает:

1. Проверьте доступные действия через `aggregate_list_actions`
2. Убедитесь, что контекст поддерживает создание правил
3. Попробуйте создать правило вручную через UI AggreGate и проверьте формат

### Ошибка: "Действие не найдено"

**Причина:** Контекст не поддерживает создание правил через действия, или действия имеют другие имена.

**Решение:** 
1. Проверьте список доступных действий через `aggregate_list_actions`
2. Убедитесь, что вы работаете с правильным типом контекста
3. Правила могут быть доступны только в определенных типах контекстов

### Ошибка: "Failed to create rule"

**Причина:** Все попытки создания правила не удались.

**Решение:**
1. Проверьте сообщение об ошибке - оно содержит список доступных действий
2. Убедитесь, что у вас есть права на создание правил в контексте
3. Проверьте синтаксис выражения правила
4. Убедитесь, что триггер (переменная или событие) существует

## Рекомендации для разработчиков

### При добавлении новых инструментов для правил:

1. **Всегда проверяйте существование действия** перед его использованием
2. **Используйте пустой входной DataTable** и заполняйте через EditData команды
3. **Проверяйте наличие полей** перед установкой значений
4. **Поддерживайте различные варианты имен полей** для совместимости
5. **Предоставляйте подробные сообщения об ошибках** с информацией о доступных действиях

### При работе с правилами:

1. **Проверяйте доступные действия** перед созданием правила
2. **Используйте простые выражения** для начального тестирования
3. **Проверяйте синтаксис выражений** перед созданием правила
4. **Убедитесь, что триггеры существуют** (переменные или события)

---

**Версия:** 1.0.0  
**Дата:** 2025-01-27  
**Статус:** ✅ Руководство создано для предотвращения ошибок при создании правил
