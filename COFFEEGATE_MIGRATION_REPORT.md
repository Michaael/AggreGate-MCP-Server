# Отчет о миграции CoffeeGate

## Дата начала: 2025-01-27

## Цель
Перенести приложение CoffeeGate с сервера **62.109.25.124** на **localhost** с оптимизацией структуры.

## Выполненные работы

### 1. Анализ структуры приложения

✅ **Проанализирована структура приложения CoffeeGate:**
- **50+ моделей** для управления кофемашинами, объектами, отчетами, инцидентами
- **3 устройства** кофемашин (WMF, drCoffee)
- **30+ дашбордов** для веб-интерфейса
- **6 отчетов** по различным метрикам
- **2 тревоги** для инцидентов
- **3 приложения** для передачи данных
- **5 виджетов** для интерфейса

### 2. Создание базовой модели cmMain

✅ **Создана модель `cmMain` на localhost:**
- Контекст: `users.admin.models.cmMain`
- Тип: Абсолютная модель (type=1)
- Описание: "Главные справочники CoffeeGate"

✅ **Созданы переменные:**
1. `regions` - Справочник регионов
   - Формат: `<id><L><description><S>`
   - Данные: 13 записей (регионы России)
   
2. `drinks` - Напитки
   - Формат: `<article><L><description><S>`
   - Данные: 61 запись (различные напитки: капучино, латте, американо и т.д.)
   
3. `models` - Модели машин
   - Формат: `<model><S><type_context_id><S><intf_context_id><S>`
   - Данные: 6 записей (WMF1920, WMF1950, WMF5000S, CoffeeBar, F2Plus, Proxima F2)
   
4. `managementForms` - Формы управления
   - Формат: `<id><I><description><S>`
   - Данные: 4 записи (COCO, CODO, COPO, CORO)
   
5. `log` - Лог сообщений
   - Формат: `<ts><D><message><S>`
   - Данные: пусто (для логирования)

✅ **Импортированы данные:**
- Все данные из переменных успешно импортированы на localhost

### 3. Анализ функций модели

✅ **Обнаружены функции модели cmMain:**
- `getDrinksList()` - Список напитков (Expression функция)
- `addDrink(article, description)` - Добавить напиток (Expression функция)
- `getRegionsList()` - Справочник регионов (Expression функция)
- И множество других функций для управления справочниками

## План оптимизации

### Удаление дубликатов
Следующие контексты будут пропущены:
- ❌ `cmCoffeeMachinesItems_rep` - дубликат
- ❌ `cmLogAnalyze_copy` - дубликат
- ❌ `frontendConfig_copy` - дубликат
- ❌ Дашборды с суффиксами `_copy`, `_old`, `_v2_old`

### Объединение похожих моделей
- `cmReportSells` → использовать только `cmReportSellsDetailed`
- `cmReportCleans` → использовать только `cmReportCleansDetailed`

### Упрощение структуры
- Рассмотреть объединение презентаторов
- Упростить структуру привязок
- Оптимизировать запросы к БД

## Текущий прогресс

### Модели
- ✅ `cmMain` - создана, переменные созданы, данные импортированы
- ⏳ Остальные 49+ моделей - ожидают миграции

### Устройства
- ⏳ 3 устройства - ожидают миграции

### Дашборды
- ⏳ 30+ дашбордов - ожидают миграции

### Отчеты
- ⏳ 6 отчетов - ожидают миграции

### Приложения
- ⏳ 3 приложения - ожидают миграции

### Тревоги
- ⏳ 2 тревоги - ожидают миграции

### Виджеты
- ⏳ 5 виджетов - ожидают миграции

**Общий прогресс:** ~2% (1 модель из ~50)

## Следующие шаги

### Немедленные действия:
1. Создать функции модели `cmMain` на localhost
2. Создать события модели `cmMain` (если есть)
3. Создать привязки модели `cmMain` (если есть)

### Приоритетные модели для миграции:
1. `cmSettings` - Настройки системы
2. `cmMachineTypes` - Типы кофемашин
3. `cmSites` - Разделы
4. `cmStructure` - Организационная структура
5. `cmMachinesManager` - Менеджер кофемашин
6. `cmMachinesPresenter` - Презентатор кофемашин
7. `cmCoffeeMachinesItems` - Экземпляры кофемашин

### Долгосрочные задачи:
1. Мигрировать все остальные модели
2. Мигрировать устройства
3. Мигрировать дашборды
4. Мигрировать виджеты
5. Мигрировать приложения
6. Мигрировать тревоги
7. Выполнить оптимизацию

## Рекомендации

1. **Использовать поэтапный подход** - мигрировать по группам моделей
2. **Тестировать после каждого этапа** - проверять работоспособность
3. **Документировать изменения** - фиксировать все изменения структуры
4. **Оптимизировать после миграции** - удалить дубликаты и неиспользуемые компоненты

## Созданные файлы

1. `COFFEEGATE_MIGRATION_PLAN.md` - Детальный план миграции
2. `COFFEEGATE_MIGRATION_STATUS.md` - Текущий статус миграции
3. `COFFEEGATE_MIGRATION_INSTRUCTIONS.md` - Инструкции по миграции
4. `coffeegate_migration_script.py` - Скрипт для автоматизации
5. `migrate_coffeegate.py` - Вспомогательный скрипт

## Заключение

Миграция приложения CoffeeGate начата. Создана базовая модель `cmMain` с полной структурой переменных и данными. Для завершения полной миграции потребуется продолжить работу по переносу остальных ~49 моделей и других компонентов приложения.

Рекомендуется продолжить миграцию поэтапно, начиная с базовых справочников и моделей управления, затем переходя к отчетам и остальным компонентам.

---

**Статус:** В процессе  
**Прогресс:** 2%  
**Следующий этап:** Создание функций и событий модели cmMain, затем миграция базовых справочников
