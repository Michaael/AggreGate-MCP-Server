# Сводка исправлений: Правила для inputFormat множественных полей

## Проблема

При создании Expression функций с несколькими входными полями, AggreGate теряет поля после первого, если использовать формат БЕЗ `<<>>` скобок.

## Решение

Добавлено правило: **Для функций с множественными полями использовать формат С `<<>>` скобками.**

## Обновленные файлы

### 1. `docs/MCP_EXPRESSION_RULES.md`
- ✅ Добавлено правило о разных форматах для одного и множественных полей
- ✅ Обновлены примеры создания функций
- ✅ Обновлен чек-лист с проверкой формата

### 2. `AI_WORKFLOW_RULES.md`
- ✅ Добавлено правило об исправлении inputFormat для множественных полей
- ✅ Обновлен пример создания функции с проверкой формата
- ✅ Добавлено правило в итоговый чек-лист

### 3. `AI_AUTO_TESTING_GUIDE.md`
- ✅ Добавлена проверка количества полей после создания функции
- ✅ Добавлено предупреждение о потере полей

### 4. `docs/MCP_AI_QUICK_REFERENCE.md`
- ✅ Добавлены примеры для одного и множественных полей
- ✅ Добавлено предупреждение о формате `<<>>`

### 5. `auto_validate_task.py`
- ✅ Добавлена проверка inputFormat после создания
- ✅ Добавлена поддержка DataTable формата для тестирования множественных полей
- ✅ Добавлено автоматическое определение проблемы с форматом

### 6. `auto_fix_input_format.py` (новый файл)
- ✅ Функция автоматического исправления формата
- ✅ Функция определения и исправления проблемы

### 7. `docs/MCP_INPUT_FORMAT_RULES.md` (новый файл)
- ✅ Полное руководство по правилам inputFormat
- ✅ Примеры для разных случаев
- ✅ Автоматическое исправление

### 8. `README_AI_AUTO_TESTING.md`
- ✅ Обновлены ключевые правила
- ✅ Добавлено предупреждение о формате `<<>>`

## Правила для ИИ

### При создании функции с множественными полями:

1. **Определить количество полей:**
   ```python
   if len(inputFields) > 1:
       # Использовать формат С <<>>
       inputFormat = f"<<{''.join([f'<{f['name']}><{f['type']}>' for f in inputFields])}>>"
   else:
       # Использовать формат БЕЗ <<>>
       inputFormat = f"<{inputFields[0]['name']}><{inputFields[0]['type']}>"
   ```

2. **После создания проверить:**
   ```python
   func = aggregate_get_function(path, functionName)
   if len(func.inputFields) < len(inputFields):
       # ПРОБЛЕМА: пересоздать с <<>>
   ```

3. **При тестировании:**
   ```python
   if len(inputFields) > 1:
       # Использовать aggregate_call_function с DataTable
       result = aggregate_call_function(..., parameters={"records": [...], "format": {...}})
   else:
       # Использовать aggregate_test_function
       result = aggregate_test_function(..., parameters={...})
   ```

## Результат

Теперь ИИ будет:
- ✅ Автоматически определять, нужен ли формат с `<<>>`
- ✅ Проверять inputFormat после создания
- ✅ Автоматически исправлять проблему
- ✅ Использовать правильный способ тестирования

## Проверка работы

Функция `checkRangeCorrect` в модели `alarm_delayed_sum_v2` работает правильно:
- Создана с форматом `<<Int><E><Float><E>>`
- Вызывается через DataTable формат
- Возвращает правильные результаты
